#!/usr/local/bin/perl

use strict;
use diagnostics;

use lib '/usr/local/apache2/mylib/myfleet.org/';

use CGI;
use CGI::Carp qw(fatalsToBrowser);
use MyfleetConfig qw(%config);

use Myfleet::Header;
use Myfleet::DB;
use Myfleet::Util;
use Myfleet::Regatta;
use Myfleet::MessageBoard;
use Data::Dumper;

print display_page( new CGI() );

sub display_page
{
	my ( $q ) = @_;
	
	my @ret;


	if ( $q->param('f') ) {
		$q->param('r', $q->param('f') - 1000 );
	}

	if ( $q->param('r') )
	{
		if ( $q->param('Looking') || $q->param('Sailing') ) {
			my $status = ( $q->param('Looking') ? 'Looking' : 'Sailing' );
			if ( $q->param('sailnumber') || $q->param('boatname') || $q->param('skipper') ) {
				my $dbh = Myfleet::DB::connect();
				my $stx = $dbh->prepare("delete from boats where regattaid = ? and sailnumber = ?");
				$stx->execute( $q->param('r'), $q->param('sailnumber') );

				my $sailnumber = $q->param('sailnumber');
				my $skipper = $q->param('skipper');
				my $boatname = $q->param('boatname');
				my $note = $q->param('note');

				# remove html
				$sailnumber =~ s/</&lt;/g; $sailnumber =~ s/>/&rt;/g;
				$skipper =~ s/</&lt;/g; $skipper =~ s/>/&rt;/g;
				$boatname =~ s/</&lt;/g; $boatname =~ s/>/&rt;/g;
				$note =~ s/</&lt;/g; $note =~ s/>/&rt;/g;

				my $sth = $dbh->prepare("insert into boats ( regattaid, sailnumber, skipper, crew, note, status ) values (?,?,?,?,?,?)");
				$sth->execute( $q->param('r'), $sailnumber, $skipper, $boatname, $note, $status );
				$q->cookie('sailnumber',$q->param('sailnumber'));
				$q->cookie('boatname',$q->param('boatname'));
				$q->cookie('skipper',$q->param('skipper'));
			}
		}
		# regatta page
		return Myfleet::MessageBoard::display_page( $q );
	}
	else
	{
		# event listing

		my $dbh = Myfleet::DB::connect();
		my $sth = $dbh->prepare("select distinct year(startdate) year from regatta order by year desc");
		$sth->execute();
		my @years;
		while( my ( $y ) = $sth->fetchrow_array ) {
			push @years, $y;
		}
		my $year = $q->param('y') || $years[0];
		my $series = $q->param('series') || '';

		my @seriesLegend;
		my $seriesname = 'Regattas';
		foreach my $s ( @{$config{'series'} } )
		{
			my $styleString = '';
			if( $s->{'style'} eq 'bold' || $s->{'style'} eq 'italic' || $s->{'style'} eq 'asterisk' )
			{
				$styleString = "($s->{'style'})";
			}
			if( $s->{'dbname'} eq $series )
			{
				push @seriesLegend,
					lc($s->{'name'}) . " series $styleString";
					$seriesname = $s->{'name'} . " Series";
			}
			else
			{
				push @seriesLegend,
					"<a href=\"$s->{'dbname'}\">" . lc($s->{'name'}) . " series $styleString</a> ";
			}
		}

		my $title = "$year $seriesname - $config{'defaultTitle'}";

		push @ret,
			$q->header,
			Myfleet::Header::display_header( $config{'EventsMenu'}, '..', $title ),
			'<br/>',
			'<table border="0" cellpadding="4" cellspacing="0" width="100%">',
				'<tr bgcolor="silver">',
					'<td>', "<big><b>$year Events</b></big>", '</td>';

		if ( scalar( @years ) > 1 ) {
			push @ret, '<td align="right">Years: ';
			foreach my $yr ( @years ) {
				if ( $yr ne $year ) {
					push @ret, "<a href=\"?y=$yr\">$yr</a> ";
				} else {
					push @ret, "<b>$yr</b> ";
				}
			}
			push @ret, '</td>';
		}
		push @ret,
			"</table>";
		
		# display series designators
		if( @seriesLegend )
		{
			if( $series eq '' )
			{
				unshift @seriesLegend, 'all events';
			}
			else
			{
				unshift @seriesLegend, '<a href="/schedule/">all events</a>';
			}
			push @ret, '<div style="padding:0.3em 0;">' . join(' | ', @seriesLegend ) . '</div>';
		}

		push @ret,
			Myfleet::Regatta::display_events( $year, 'Regular', $series );
	}

	push @ret, Myfleet::Header::display_footer();

	return @ret;
}
